<!DOCTYPE html>
<html>
  <link href="{{ url_for('static', filename='detect.css') }}" rel="stylesheet">
  <head>
    <title>detect and log page</title>
    <!-- Import TensorFlow.js library -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs/dist/tf.min.js" type="text/javascript"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <link href="https://vjs.zencdn.net/8.5.2/video-js.css" rel="stylesheet" />
    <script src="https://vjs.zencdn.net/8.5.2/video.min.js"></script>

    <script src="/static/script/predict.js" type="module"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  </head>

  <body>
    <a id="target" style="display: none"></a> <!--이미지 저장하기 위해 canvas 그리는 용도. 화면에 표기 안 됨-->
    <div class="container">
      <div class="subcontainer top">
        <div class='left'>
            <div class='bar'>{{ region_and_name }}  실시간 cctv 영상</div>
            <div id="view" class="drawBlock">
              <video id="inputVideo" controls width="640" height="360" autoplay muted crossorigin="anonymous">
                <source src="{{ video_src }}">
              </video>
              <script>
                const isM3u8 = '{{ video_src }}'.endsWith('m3u8');
                function setM3u8Attributes(){
                  var tagToRefresh = document.getElementById('inputVideo');
                  tagToRefresh.setAttribute('data-setup', '{}');
                  tagToRefresh.setAttribute('class', 'video-js');
                }

                if (isM3u8) {
                  setM3u8Attributes();
                  console.log('m3u8');
                }
                if (false) { // video.playing 확인 필요. listener 적용해볼 것
                  console.log('비디오 재생중 아니기 때문에 reload')
                  // https://stackoverflow.com/a/31133401
                  Object.defineProperty(HTMLMediaElement.prototype, 'playing', {
                    get: function(){
                        return !!(this.currentTime > 0 && !this.paused && !this.ended && this.readyState > 2);
                    }
                  })
                  if (document.querySelector('video').playing){ // checks if element is playing right now
                      // Do anything you want to
                  }
                }
                
                // // setTimeout(reload, 1000)
                // function reload() {
                //   // console.lo
                //   const parent = document.getElementById('view');
                //   var tagToRefresh = document.getElementById('inputVideo');
                //   // parent.removeChild(tagToRefresh);
                //   // parent.appendChild(tagToRefresh);
                //   location.reload();
                //   console.log('what?')
                // }
                // declare some global variables
                const view = document.getElementById('view');
                let showSelection = false;
                let Xstart;
                let Ystart;

                $(view).ready(function(){

                    $(view).mousedown(function(event){
                        // set a variable that indicates the user is drawing a selection
                        showSelection=true;

                        // save the position where the mouse click started
                        Xstart=event.pageX - view.offsetLeft;
                        Ystart=event.pageY - view.offsetTop;
                        // Xstart=event.pageX;
                        // Ystart=event.pageY;
                        console.log('Xstart: ' + Xstart)
                        console.log('Ystart: ' + Ystart)

                        // create the select box element and give it some starting positions
                        $('<div id="selection"></div>')
                            .css({
                                "left": Xstart + 'px',
                                "top": Ystart + 'px',
                            })
                        .appendTo(view);
                        $( ".area" ).remove();
                    });

                    $(view).mousemove(function(event){
                        
                        // if we are making a selection lets keep updating our select box dimensions
                        if(showSelection == true) {
                            
                            // horizontal selection
                            if (event.pageX-view.offsetLeft > Xstart) {
                                // left to right
                                $('#selection').css({
                                    "width": (event.pageX-view.offsetLeft)-Xstart + 'px'
                                    // "width": event.pageX-Xstart+view.offsetLeft + 'px'
                                    // "width": event.pageX-Xstart + 'px'
                                })
                            }else {
                                // right to left
                                $('#selection').css({
                                    "left": event.pageX-view.offsetLeft,
                                    // "width": Xstart-event.pageX-view.offsetLeft + 'px'
                                    "width": Xstart-(event.pageX-view.offsetLeft) + 'px'
                                    // "width": Xstart-event.pageX + 'px'
                                })
                            }

                            // vertical selection
                            if (event.pageY-view.offsetTop > Ystart) {
                                // top to bottom
                                $('#selection').css({
                                    "height": (event.pageY-view.offsetTop)-Ystart + 'px'
                                    // "height": event.pageY-Ystart + 'px'
                                })
                            } else {
                                // bottom to top
                                $('#selection').css({
                                    "top": (event.pageY-view.offsetTop),
                                    "height": Ystart-(event.pageY-view.offsetTop) + 'px'
                                    // "height": Ystart-event.pageY + 'px'
                                })
                            }
                        }

                    });

                    $(view).mouseup(function(event){

                        // we can borrow the needed values from the #selection element to draw our 'area' :)
                        LeftVal = $("#selection").css('left')
                        TopVal = $("#selection").css('top')
                        WidthVal = $("#selection").css('width')
                        HeightVal = $("#selection").css('height')

                        // create the area element and give it the dimensions
                        $('<div class="area"></div>')
                            .css({
                                "left": LeftVal,
                                "top": TopVal,
                                "width": WidthVal,
                                "height": HeightVal
                            })
                            .appendTo(view);
                        
                        // get rid of the selection element from the DOM
                        $( "#selection" ).remove();
                        // and set our showSelection variable back to false
                        showSelection=false;

                    });
                });
              </script>
            </div>
        </div>

        <div class='right'>

          <div class='bar'>로그</div>
          
          <table>
            <tr style='text-align: center;'>
              <td>ID</td>
              <td>날짜</td>
              <td>시간</td>
              <td>위반사항</td>
              <td>좌표</td>
            <tr>
            <tr style='text-align: center;'>
              <td>--</td>
              <td>--</td>
              <td>--</td>
              <td>--</td>
              <td>--</td>
            </tr>
          </table>

          <button class="save-button" type="button"> 영상 저장 </button>
          <button class="save-button" type="button"> 이미지 저장 </button>

        </div>
      </div>
      <div class="subcontainer bottom">
        <div class='bar'>실시간 탐지 상황</div>
        <div id="test" class="drawBlock"></div>
      </div>
    </div>

  </body>

</html>